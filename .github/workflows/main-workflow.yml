name: Main Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ci:
    name: CI lint, type, test, build
    uses: ./.github/workflows/reusable-ci.yml

  security:
    name: Security scans
    permissions:
      security-events: write
      actions: read
      contents: read
      packages: read
    uses: ./.github/workflows/reusable-security.yml

  docs:
    name: Deploy Documentation
    permissions:
      contents: write
      pages: write
      id-token: write
    # Only run docs if documentation files change
    if: |
      contains(github.event.head_commit.modified, 'docs/') ||
      contains(github.event.head_commit.modified, 'README.md') ||
      contains(github.event.head_commit.modified, 'CONTRIBUTING.md') ||
      contains(github.event.head_commit.modified, 'mkdocs.yml')
    uses: ./.github/workflows/reusable-docs.yml

  cd-dev:
    name: CD Dev Publishing
    needs: [ci, security, docs]
    if: |
      !cancelled() &&
      needs.ci.outputs.overall-success == 'true' &&
      needs.security.outputs.overall-success == 'true' &&
      (needs.docs.result == 'success' || needs.docs.result == 'skipped') &&
      (contains(github.event.head_commit.modified, 'src/') ||
      contains(github.event.head_commit.modified, 'pyproject.toml'))
    uses: ./.github/workflows/reusable-cd-dev.yml
    secrets: inherit

  debug-deps:
    runs-on: ubuntu-latest
    needs: [ci, security, docs]
    steps:
      - name: Debug outputs
        if: ${{ always() }}
        run: |
          echo "CI result: ${{ needs.ci.result }}"
          echo "CI overall-success: ${{ needs.ci.outputs.overall-success }}"
          echo "Security result: ${{ needs.security.result }}"
          echo "Security overall-success: ${{ needs.security.outputs.overall-success }}"
          echo "Docs result: ${{ needs.docs.result }}"
          echo "Modified files: ${{ join(github.event.head_commit.modified, ', ') }}"

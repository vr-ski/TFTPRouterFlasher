name: Main Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ci:
    uses: ./.github/workflows/reusable-ci.yml

  security:
    permissions:
      security-events: write
      actions: read
      contents: read
      packages: read
    uses: ./.github/workflows/reusable-security.yml

  docs:
    permissions:
      contents: write
      pages: write
      id-token: write
    # Only run docs if documentation files change
    if: |
      contains(github.event.head_commit.modified, 'docs/') ||
      contains(github.event.head_commit.modified, 'README.md') ||
      contains(github.event.head_commit.modified, 'CONTRIBUTING.md') ||
      contains(github.event.head_commit.modified, 'mkdocs.yml')
    uses: ./.github/workflows/reusable-docs.yml

  cd-dev:
    needs: [ci, security, docs]
    if: |
      needs.ci.outputs.overall-success == 'true' &&
      needs.security.outputs.overall-success == 'true' &&
      (needs.docs.result == 'success' || needs.docs.result == 'skipped') &&
      (contains(github.event.head_commit.modified, 'src/') ||
       contains(github.event.head_commit.modified, 'pyproject.toml'))
    uses: ./.github/workflows/reusable-cd-dev.yml
    secrets: inherit
